.PHONY: help \
	install install-frontend install-backend \
	dev dev-frontend dev-backend \
	build build-frontend build-backend build-release \
	fmt fmt-frontend fmt-backend \
	lint lint-frontend lint-backend \
	typecheck \
	test test-backend test-frontend \
	clean clean-frontend clean-backend clean-all

# é¡¹ç›®è·¯å¾„
PROJECT_DIR := .
FRONTEND_DIR := $(PROJECT_DIR)
BACKEND_DIR := $(PROJECT_DIR)/src-tauri

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

## help: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "w2-db-query - æ•°æ®åº“æŸ¥è¯¢å·¥å…· Makefile å‘½ä»¤"
	@echo ""
	@echo "ä¾èµ–ç®¡ç†:"
	@echo "  make install              - å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå‰ç«¯ npm + åç«¯ cargoï¼‰"
	@echo "  make install-frontend     - ä»…å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆnpm installï¼‰"
	@echo "  make install-backend      - ä»…å®‰è£…åç«¯ä¾èµ–ï¼ˆcargo buildï¼‰"
	@echo ""
	@echo "å¼€å‘:"
	@echo "  make dev                 - å¯åŠ¨ Tauri å¼€å‘æ¨¡å¼ï¼ˆå‰ç«¯ + åç«¯ï¼‰"
	@echo "  make dev-frontend        - ä»…å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆViteï¼‰"
	@echo ""
	@echo "æ„å»º:"
	@echo "  make build               - æ„å»ºåº”ç”¨ï¼ˆDebug æ¨¡å¼ï¼‰"
	@echo "  make build-release       - æ„å»ºåº”ç”¨ï¼ˆRelease æ¨¡å¼ï¼Œç”Ÿäº§ç‰ˆæœ¬ï¼‰"
	@echo "  make build-frontend      - ä»…æ„å»ºå‰ç«¯ï¼ˆTypeScript + Viteï¼‰"
	@echo "  make build-backend       - ä»…æ„å»ºåç«¯ï¼ˆCargoï¼‰"
	@echo ""
	@echo "ä»£ç è´¨é‡:"
	@echo "  make fmt                 - æ ¼å¼åŒ–æ‰€æœ‰ä»£ç ï¼ˆRust + TypeScriptï¼‰"
	@echo "  make fmt-frontend        - æ ¼å¼åŒ–å‰ç«¯ä»£ç ï¼ˆPrettierï¼‰"
	@echo "  make fmt-backend         - æ ¼å¼åŒ–åç«¯ä»£ç ï¼ˆcargo fmtï¼‰"
	@echo "  make lint                - æ£€æŸ¥æ‰€æœ‰ä»£ç ï¼ˆRust + TypeScriptï¼‰"
	@echo "  make lint-frontend       - æ£€æŸ¥å‰ç«¯ä»£ç ï¼ˆESLintï¼‰"
	@echo "  make lint-backend        - æ£€æŸ¥åç«¯ä»£ç ï¼ˆcargo clippyï¼‰"
	@echo "  make typecheck           - TypeScript ç±»å‹æ£€æŸ¥"
	@echo ""
	@echo "æµ‹è¯•:"
	@echo "  make test                - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-backend        - è¿è¡Œåç«¯æµ‹è¯•ï¼ˆcargo testï¼‰"
	@echo ""
	@echo "æ¸…ç†:"
	@echo "  make clean               - æ¸…ç†æ„å»ºäº§ç‰©ï¼ˆå‰ç«¯ + åç«¯ï¼‰"
	@echo "  make clean-frontend      - æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©"
	@echo "  make clean-backend       - æ¸…ç†åç«¯æ„å»ºäº§ç‰©"
	@echo "  make clean-all           - æ¸…ç†æ‰€æœ‰ï¼ˆåŒ…æ‹¬ node_modules å’Œ targetï¼‰"

## install: å®‰è£…æ‰€æœ‰ä¾èµ–
install: install-frontend install-backend
	@echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

## install-frontend: å®‰è£…å‰ç«¯ä¾èµ–
install-frontend:
	@echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
	@cd $(FRONTEND_DIR) && npm install --legacy-peer-deps
	@echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"

## install-backend: å®‰è£…åç«¯ä¾èµ–ï¼ˆé€šè¿‡æ„å»ºï¼‰
install-backend:
	@echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
	@cd $(BACKEND_DIR) && cargo build
	@echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

## dev: å¯åŠ¨ Tauri å¼€å‘æ¨¡å¼
dev:
	@echo "ğŸš€ å¯åŠ¨ Tauri å¼€å‘æ¨¡å¼..."
	@echo "âš ï¸  ä½¿ç”¨ Ctrl+C åœæ­¢"
	@cd $(FRONTEND_DIR) && npm run tauri dev

## dev-frontend: ä»…å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
dev-frontend:
	@echo "ğŸš€ å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
	@echo "âš ï¸  ä½¿ç”¨ Ctrl+C åœæ­¢"
	@cd $(FRONTEND_DIR) && npm run dev

## build: æ„å»ºåº”ç”¨ï¼ˆDebug æ¨¡å¼ï¼‰
build:
	@echo "ğŸ”¨ æ„å»ºåº”ç”¨ï¼ˆDebug æ¨¡å¼ï¼‰..."
	@cd $(FRONTEND_DIR) && npm run tauri build --debug
	@echo "âœ… æ„å»ºå®Œæˆ"

## build-release: æ„å»ºåº”ç”¨ï¼ˆRelease æ¨¡å¼ï¼Œç”Ÿäº§ç‰ˆæœ¬ï¼‰
build-release:
	@echo "ğŸ”¨ æ„å»ºåº”ç”¨ï¼ˆRelease æ¨¡å¼ï¼Œç”Ÿäº§ç‰ˆæœ¬ï¼‰..."
	@cd $(FRONTEND_DIR) && npm run tauri build
	@echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ: $(BACKEND_DIR)/target/release/bundle/"

## build-frontend: ä»…æ„å»ºå‰ç«¯
build-frontend:
	@echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
	@cd $(FRONTEND_DIR) && npm run build
	@echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ: $(FRONTEND_DIR)/dist"

## build-backend: ä»…æ„å»ºåç«¯
build-backend:
	@echo "ğŸ”¨ æ„å»ºåç«¯..."
	@cd $(BACKEND_DIR) && cargo build
	@echo "âœ… åç«¯æ„å»ºå®Œæˆ: $(BACKEND_DIR)/target/debug/w2-db-query"

## fmt: æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
fmt: fmt-backend fmt-frontend
	@echo "âœ… æ‰€æœ‰ä»£ç æ ¼å¼åŒ–å®Œæˆ"

## fmt-frontend: æ ¼å¼åŒ–å‰ç«¯ä»£ç 
fmt-frontend:
	@echo "âœ¨ æ ¼å¼åŒ–å‰ç«¯ä»£ç ..."
	@cd $(FRONTEND_DIR) && npm run format
	@echo "âœ… å‰ç«¯ä»£ç æ ¼å¼åŒ–å®Œæˆ"

## fmt-backend: æ ¼å¼åŒ–åç«¯ä»£ç 
fmt-backend:
	@echo "âœ¨ æ ¼å¼åŒ–åç«¯ä»£ç ..."
	@cd $(BACKEND_DIR) && cargo fmt
	@echo "âœ… åç«¯ä»£ç æ ¼å¼åŒ–å®Œæˆ"

## lint: æ£€æŸ¥æ‰€æœ‰ä»£ç 
lint: lint-backend lint-frontend typecheck
	@echo "âœ… æ‰€æœ‰ä»£ç æ£€æŸ¥å®Œæˆ"

## lint-frontend: æ£€æŸ¥å‰ç«¯ä»£ç 
lint-frontend:
	@echo "ğŸ” æ£€æŸ¥å‰ç«¯ä»£ç ..."
	@cd $(FRONTEND_DIR) && npm run lint
	@echo "âœ… å‰ç«¯ä»£ç æ£€æŸ¥å®Œæˆ"

## lint-backend: æ£€æŸ¥åç«¯ä»£ç 
lint-backend:
	@echo "ğŸ” æ£€æŸ¥åç«¯ä»£ç ..."
	@cd $(BACKEND_DIR) && cargo clippy -- -D warnings
	@echo "âœ… åç«¯ä»£ç æ£€æŸ¥å®Œæˆ"

## typecheck: TypeScript ç±»å‹æ£€æŸ¥
typecheck:
	@echo "ğŸ” TypeScript ç±»å‹æ£€æŸ¥..."
	@cd $(FRONTEND_DIR) && npm run typecheck
	@echo "âœ… TypeScript ç±»å‹æ£€æŸ¥å®Œæˆ"

## test: è¿è¡Œæ‰€æœ‰æµ‹è¯•
test: test-backend
	@echo "âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ"

## test-backend: è¿è¡Œåç«¯æµ‹è¯•
test-backend:
	@echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
	@cd $(BACKEND_DIR) && cargo test --verbose
	@echo "âœ… åç«¯æµ‹è¯•å®Œæˆ"

## test-frontend: è¿è¡Œå‰ç«¯æµ‹è¯•ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
test-frontend:
	@echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
	@echo "âš ï¸  å‰ç«¯æµ‹è¯•å°šæœªé…ç½®"
	@echo "âœ… å‰ç«¯æµ‹è¯•è·³è¿‡"

## clean: æ¸…ç†æ„å»ºäº§ç‰©
clean: clean-frontend clean-backend
	@echo "âœ… æ„å»ºäº§ç‰©æ¸…ç†å®Œæˆ"

## clean-frontend: æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©
clean-frontend:
	@echo "ğŸ§¹ æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©..."
	@cd $(FRONTEND_DIR) && rm -rf dist node_modules/.vite .vite
	@echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©æ¸…ç†å®Œæˆ"

## clean-backend: æ¸…ç†åç«¯æ„å»ºäº§ç‰©
clean-backend:
	@echo "ğŸ§¹ æ¸…ç†åç«¯æ„å»ºäº§ç‰©..."
	@cd $(BACKEND_DIR) && cargo clean
	@echo "âœ… åç«¯æ„å»ºäº§ç‰©æ¸…ç†å®Œæˆ"

## clean-all: æ¸…ç†æ‰€æœ‰ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰
clean-all: clean-frontend clean-backend
	@echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰æ–‡ä»¶..."
	@cd $(FRONTEND_DIR) && rm -rf node_modules package-lock.json
	@cd $(BACKEND_DIR) && rm -rf Cargo.lock
	@echo "âš ï¸  å·²åˆ é™¤ node_modules å’Œ Cargo.lock"
	@echo "âœ… æ¸…ç†å®Œæˆï¼Œè¿è¡Œ 'make install' é‡æ–°å®‰è£…ä¾èµ–"
