# 功能规范：数据库查询工具

**Feature Branch**: `001-db-query`  
**Created**: 2026-01-17  
**Status**: Draft  
**Input**: 数据库查询桌面应用：支持PostgreSQL元数据管理、手动SQL查询和AI自然语言查询生成

## 用户场景与测试 *(必填)*

### 用户故事 1 - 连接数据库并浏览结构 (优先级: P1)

作为数据库用户，我需要能够添加PostgreSQL数据库连接，并自动获取和浏览数据库的结构信息（表、视图、列等），以便快速了解数据库中有哪些数据可用。

**优先级理由**: 这是应用的基础功能。没有数据库连接和元数据查看能力，后续的查询功能都无法实现。这是MVP的核心前提。

**独立测试**: 可以通过添加一个测试数据库连接，验证系统能否成功连接并显示所有表和视图的列表，无需执行任何查询即可证明价值。

**验收场景**:

1. **Given** 用户打开应用且没有配置任何数据库连接, **When** 用户输入有效的PostgreSQL连接URL并点击连接, **Then** 系统成功连接并在侧边栏显示该数据库的所有表和视图列表
2. **Given** 数据库已连接且元数据已加载, **When** 用户点击某个表名, **Then** 系统展开显示该表的所有列名、数据类型和约束信息
3. **Given** 用户已添加过一个数据库连接, **When** 用户关闭应用后重新打开, **Then** 之前的数据库连接配置自动加载，元数据直接可用无需重新连接
4. **Given** 用户输入了错误的数据库连接URL或凭据, **When** 用户尝试连接, **Then** 系统显示清晰的错误提示，说明连接失败的原因

---

### 用户故事 2 - 执行SQL查询并查看结果 (优先级: P2)

作为数据分析师，我需要能够在SQL编辑器中手动编写和执行SQL查询，并在表格中查看格式化的查询结果，以便灵活地探索和分析数据库数据。

**优先级理由**: 这是应用的核心价值功能。在能够浏览数据库结构后，用户最直接的需求就是执行查询来获取实际数据。这是从MVP到可用产品的关键步骤。

**独立测试**: 可以通过在已连接的数据库上编写并执行一个简单的SELECT查询，验证系统能否正确执行查询并以表格形式展示结果，独立证明查询功能的价值。

**验收场景**:

1. **Given** 数据库已连接且用户在SQL编辑器中, **When** 用户输入"SELECT * FROM users"并点击执行, **Then** 系统在下方以表格形式显示查询结果，列名作为表头，每行数据对应一行记录
2. **Given** 用户编写了一个不包含LIMIT子句的SELECT查询, **When** 用户执行该查询, **Then** 系统自动在查询末尾添加"LIMIT 100"并执行，同时提示用户已自动限制结果数量
3. **Given** 用户执行了包含语法错误的SQL查询, **When** 查询执行失败, **Then** 系统在编辑器下方显示清晰的错误信息，包括错误类型和位置提示
4. **Given** 用户执行了一个返回大量列的查询, **When** 结果显示在表格中, **Then** 表格支持水平滚动，所有列都可访问且列宽可调整
5. **Given** 查询结果已显示在表格中, **When** 用户查看数据, **Then** 支持在表格内垂直滚动浏览所有结果行，并显示总行数

---

### 用户故事 3 - 使用自然语言生成SQL查询 (优先级: P3)

作为非技术用户或快速分析需求的用户，我需要能够用自然语言描述我的查询需求，让系统自动生成对应的SQL查询，以便在不熟悉SQL语法的情况下也能高效查询数据。

**优先级理由**: 这是高级增强功能，显著提升用户体验和可用性，但不是MVP必需。在基础查询功能完善后添加，能够吸引更广泛的用户群体。

**独立测试**: 可以通过输入自然语言描述"显示所有年龄大于30岁的用户"，验证系统能否生成正确的SQL查询并允许用户审查和执行，独立展示AI辅助功能的价值。

**验收场景**:

1. **Given** 数据库元数据已加载且用户在自然语言输入框中, **When** 用户输入"查询所有活跃用户的姓名和邮箱"并点击生成, **Then** 系统在SQL编辑器中生成对应的SELECT查询，用户可以审查并选择执行
2. **Given** 用户用自然语言描述了查询需求, **When** AI生成SQL查询, **Then** 系统将数据库的表和列信息作为上下文提供给AI，确保生成的查询引用的表名和列名在数据库中真实存在
3. **Given** AI生成的SQL查询显示在编辑器中, **When** 用户查看生成的查询, **Then** 用户可以手动编辑查询内容，然后再执行（生成后可编辑）
4. **Given** 用户的自然语言描述模糊或无法映射到具体查询, **When** AI尝试生成查询, **Then** 系统提示用户描述不够明确，并建议如何改进描述

---

### 边界情况

- **数据库连接中断**: 在查询执行过程中，数据库连接突然断开时，系统应捕获错误并显示友好提示，允许用户重新连接
- **超大结果集**: 即使有LIMIT 100的限制，某些查询可能返回包含大量列或大文本字段的结果，系统应能够处理并优雅地显示（如截断过长文本并提供查看完整内容的选项）
- **特殊字符处理**: 数据库表名或列名包含特殊字符（如空格、中文）时，系统应正确转义并显示
- **并发查询**: 用户在一个查询尚未完成时尝试执行另一个查询，系统应排队或取消前一个查询，明确告知用户当前状态
- **元数据更新**: 数据库结构在应用运行期间发生变化（新增表、删除列等），用户应能够手动刷新元数据缓存
- **空结果**: 查询返回0行结果时，系统应明确显示"无匹配结果"而不是空白或错误提示
- **数据库权限不足**: 用户连接的数据库账户缺少读取系统元数据或执行查询的权限时，系统应给出明确的权限错误提示

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须允许用户添加、编辑和删除PostgreSQL数据库连接配置（包括主机、端口、数据库名、用户名、密码）
- **FR-002**: 系统必须在用户添加数据库连接后自动连接并提取数据库的元数据（所有表、视图、列、数据类型、主键、外键等信息）
- **FR-003**: 系统必须将数据库连接配置和提取的元数据持久化存储到本地SQLite数据库中，以便下次启动时快速加载
- **FR-004**: 系统必须在用户界面的侧边栏或树形结构中展示数据库的所有表和视图，支持展开查看每个表的列详情
- **FR-005**: 系统必须提供一个SQL编辑器，支持基本的代码编辑功能（语法高亮、自动缩进、多行输入）
- **FR-006**: 系统必须允许用户在SQL编辑器中编写SQL查询并执行该查询
- **FR-007**: 系统必须在执行查询前检查查询语句，如果是SELECT查询且不包含LIMIT子句，则自动追加"LIMIT 100"
- **FR-008**: 系统必须将查询结果以表格形式展示，列名作为表头，每行数据库记录对应表格的一行
- **FR-009**: 系统必须在查询执行失败时，显示清晰的错误信息（语法错误、权限错误、连接错误等）
- **FR-010**: 系统必须提供自然语言查询输入界面，允许用户用中文或英文描述查询需求
- **FR-011**: 系统必须调用AI服务（LLM），将用户的自然语言描述和数据库元数据作为上下文，生成对应的SQL查询
- **FR-012**: 系统必须将AI生成的SQL查询展示在SQL编辑器中，允许用户审查、编辑后再执行
- **FR-013**: 系统必须支持用户手动刷新数据库元数据（重新从数据库提取最新结构）
- **FR-014**: 系统必须在长时间运行的查询执行期间显示加载指示器，并允许用户取消正在执行的查询

### 关键实体 *(包含数据相关功能)*

- **DatabaseConnection（数据库连接）**: 表示一个PostgreSQL数据库连接，包括连接URL、主机、端口、数据库名、用户凭据、连接状态等属性
- **DatabaseMetadata（数据库元数据）**: 表示某个数据库的结构信息，包括表列表、视图列表，每个表/视图的列信息、数据类型、约束关系等
- **Table（表）**: 表示数据库中的一个表或视图，包括名称、类型（表/视图）、列列表、主键、外键等信息
- **Column（列）**: 表示表中的一个列，包括列名、数据类型、是否可空、默认值、是否为主键等属性
- **SQLQuery（SQL查询）**: 表示用户编写或AI生成的SQL查询语句，包括原始查询文本、解析后的查询结构、执行状态等
- **QueryResult（查询结果）**: 表示查询执行后的结果集，包括列名列表、行数据（键值对数组）、总行数、执行时间等信息
- **NaturalLanguageQuery（自然语言查询）**: 表示用户的自然语言查询描述，包括原始文本、目标数据库上下文、生成的SQL查询等

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户能够在30秒内成功添加一个数据库连接并看到数据库结构信息
- **SC-002**: 用户在SQL编辑器中编写并执行一个查询后，能在2秒内看到查询结果（对于小于1000行的结果集）
- **SC-003**: 系统能够正确处理和显示包含最多100列和100行的查询结果，表格滚动流畅无卡顿
- **SC-004**: 90%的常见自然语言查询描述（如"查询所有用户"、"显示最近10条订单"）能够生成语法正确且语义符合用户意图的SQL查询
- **SC-005**: 应用启动后加载已保存的数据库连接和元数据缓存的时间少于3秒
- **SC-006**: 用户在第一次使用应用时，能够在5分钟内完成添加连接、浏览结构、执行第一个查询的完整流程
- **SC-007**: 查询执行错误时，85%的用户能够根据错误提示理解问题并知道如何修正（通过用户反馈或测试验证）

## 假设 *(默认假设)*

- 用户主要使用PostgreSQL数据库（未来可能扩展支持其他数据库，但当前版本仅支持PostgreSQL）
- 用户使用的数据库账户具有读取系统元数据表（如`information_schema`）和执行SELECT查询的权限
- 用户的网络环境可以访问OpenAI API或配置的LLM服务（用于自然语言查询生成）
- 单个查询结果集通常不超过10,000行（通过LIMIT 100限制），数据量在合理范围内
- 数据库表名和列名主要使用英文或标准命名约定，特殊字符使用较少
- 应用运行在桌面环境（Windows、macOS、Linux），具有本地文件系统访问权限用于SQLite存储
